#! /bin/bash

#
# T3/BREEDBASE SETUP SCRIPT
# This script will pull the latest database and web images from Docker Hub
# It will then process the scripts in the setup.d directory for additional setup
#


# Path to Docker binaries
DOCKER="$(which docker)"

# Paths to Breedbase scripts, files, etc
BREEDBASE="$BB_HOME/bin/breedbase"
SETUP_SCRIPTS="$BB_HOME/bin/setup.d/"


# Script that is specified to run
# skip the docker pulls
# force running the specified script
SCRIPT="" 
if [[ ! -z "$1" ]]; then
    files=$(find "$SETUP_SCRIPTS" -name "$1*.sh")
    count=$(echo -n "$files" | grep -c '^')
    if [[ $count -eq 0 ]]; then
        echo "ERROR: no matching script found!"
        exit 1
    elif [[ $count -gt 1 ]]; then
        echo "ERROR: multiple matching scripts found!"
        exit 1
    else
        SCRIPT=$(basename "$files")
    fi
fi


echo "======== T3/BREEDBASE INITIAL SETUP ========"


#
# DOWNLOAD DOCKER IMAGES
#
if [ -z "$SCRIPT" ]; then
    echo ""
    echo "==> Downloading T3/Breedbase Database Image [$BB_DB_REPO]..."
    db_update=$("$DOCKER" pull "$BB_DB_REPO")
    db_update_status=$(echo "$db_update" | grep ^Status)
    echo "$db_update_status"

    echo "==> Downloading T3/Breedbase Web Image [$BB_WEB_REPO]..."
    web_update=$("$DOCKER" pull "$BB_WEB_REPO")
    web_update_status=$(echo "$web_update" | grep ^Status)
    echo "$web_update_status"
fi


#
# RUN SETUP SCRIPTS
#
if [ -z "$SCRIPT" ]; then
    scripts="*.sh"
else
    scripts="$SCRIPT"
fi
for f in "$SETUP_SCRIPTS"/$scripts; do
    echo ""
    echo "[$(basename $f)]"
    if ! BB_HOME="$BB_HOME" $(which bash) "$f"; then 
        echo "ERROR: Setup script failed! [$f]"
        exit 1
    fi
done


#
# DISPLAY BASIC HELP INFO
# 
if [ -z "$SCRIPT" ]; then
    echo ""
    echo "======== INTIAL T3/BREEDBASE SETUP COMPLETE ========"
    echo "To start/stop the services use the 'breedbase' script located at:"
    echo "$BREEDBASE"
    echo "Examples:"
    echo "breedbase start - starts all services (database and all web instances)"
    echo "breedbase start triticum - starts specified services (database and wheat instance)"
    echo "breedbase stop - stops all services"
    echo "breedbase stop triticum - stops the specified services (wheat instance)"
    echo ""
    echo "Refer to the README.md document for more information on configuration options."
fi
